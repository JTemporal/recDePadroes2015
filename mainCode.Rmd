# Bem vindo ao C√≥digo Principal do nosso projeto
Neste aquivo voc√™ encontra um guideline para fazer o download de seus dados de interesse
assim como fazer uns neg√≥cios da hora com eles...

Use com modera√ß√£o e divirta-se

M√£os √† obra!
-------------------------------
Rode os seguintes comandos no seu R favorito. N√≥s estamos usando oficialmente 
a vers√£o 3.0.2 na plataforma i686-pc-linux-gnu (32-bit) para rodar nossos 
testes.

Para carregar as bibliotecas necess√°rias e as fun√ß√µes descritas nesse projeto use:
```{r}
source("Requirements.R")
source("funcoes/Functions.R")
```

Para continuar listaremos em um vetor todos os estudos que queremos. Como
exemplo usaremos um artigo sobre Degue que pode ser encontrado [nesse link](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC4116428/)
e os dados podem ser obtidos [nesse link aqui](http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE51808).

No nosso estudo teste, o ID que nos leva ao arquivo 'matrix' √© GSE51808. 
Atribuindo ele como uma string a um vetor (que vamos carinhosamente chamar de gse)
e usando as seguintes fun√ß√µes, n√≥s podemos fazer o download do arquivo
e ler os dados em um objeto com o mesmo nome do ID do estudo.

Ent√£o vamos l√°!
- Criando o vetor:
```{r}
gse <- "GSE51808"
```
- Obtendo o link para download:
```{r}
link <- getLinkDownloadMatrix(gse)
```
- Fazendo o download:

(aqui voc√™ dever√° obter uma mensagem de sucesso quando o download termina
(Se voc√™ estiver usando o GUI do R no windows pode ser que ele mostre um aviso
pedindo permiss√o para fazer o download, √©s√≥aceitar)
```{r}
downloadMatrix(link)
```
- Lendo os dados:
```{r}
dados <- readMyData(gse)
```
O objeto dados √© um tipo lista e cada n√≠vel corresponder√° √† um estudo (caso
voc√™ tenha mais de um estudo). Cada n√≠vel ao inv√©s de seguir o padr√£o 1, 2..
√© nomeado seguindo o nome do estudo correspondente.
Ent√£o para checar o comecinho da matriz podemos fazer
```{r}
dados$GSE51808[1:6,1:3]
```
Cada coluna em dados$GES51808 corresponde a uma das 56 amostras que foram 
utilizadas no artigo.

Vamos agora categorizar-las. Primeiro vamos fazer um vetor com as categorias de
pacientes, no nosso estudo os pacientes podem ser um dos quatro tipos:
- Convalescent (paciente em recupera√ß√£o)
- Dengue Fever (com febre)
- Dengue Hemorrhagic Fever (com febre hemorragica)
- Healthy Control (controles saudaveis)
```{r}
categoria <- c("Convalescent", "Healthy control", "Dengue Fever", "Dengue Hemorrhagic Fever")
```
Agora vamos criar um data.frame com as informa√ß√µes sobre as amostras por exemplo:
- o ID GSM
- o paciente que a amostra foi recolhida
```{r}
metadados <- doMeta(gse)
dfMeta <- as.data.frame(metadados$GSE51808)
```
Aqui voc√™ pode definir manualmente as cores para os tipos de paciente ou
deixar que a fun√ß√£o doColourPalette fa√ßa isso para voc√™ automaticamente
(olhe a documenta√ß√£o dessa fun√ß√£o para maiores detalhes como a quais colunas df
deve conter).

```{r}
# Manualmente:
coloring <- sample(colours(),4)
# lembre-se: voc√™ pode tamb√©m definir as cores para o plot escolhendo-as
# coloring <- c("lightcyan4", "sienna2", "green2", "lightblue")
dfMeta <- doColourPalette(dfMeta, categoria, coloring) # warnings s√£o esperados
# Automaticamente:
dfMeta <- doColourPalette(dfMeta,categoria)
```

PCA: Falta terminar (automatizar)
```{r}
km <- kmeans(t(dados$GSE51808), centers=2)
plot(t(dados$GSE51808),col=km$cluster)

transDi <- cluster::diana(t(dados$GSE51808))
hc <- as.dendrogram(transDi)

labelColors <- dfMeta$col

colLab <- function(n) {
    if (is.leaf(n)) {
        a <- attributes(n)
        labCol <- labelColors[clusMember[which(names(clusMember) == a$label)]]
        attr(n, "nodePar") <- c(a$nodePar, lab.col = labCol)
    }
    n
}

clusMember <- colnames(dados$GSE51808)
clusMember[grep("II",rownames(abundance.x))]<-2
names(clusMember)<-rownames(abundance.x)

library(ggdendro)
ggdendrogram()

1  GSM1253028              Dengue Fever Patient 3   blue 2
2  GSM1253029              Dengue Fever Patient 4   blue 2
3  GSM1253030              Dengue Fever Patient 6   blue 2
4  GSM1253031              Dengue Fever Patient 7   blue 2
5  GSM1253032 Dengue Hemorrhagic Fever Patient 32 purple 1
6  GSM1253033             Dengue Fever Patient 33   blue 
7  GSM1253034 Dengue Hemorrhagic Fever Patient 34 purple
8  GSM1253035             Dengue Fever Patient 35   blue
9  GSM1253036             Dengue Fever Patient 36   blue
10 GSM1253037 Dengue Hemorrhagic Fever Patient 81 purple
11 GSM1253038             Dengue Fever Patient 37   blue
12 GSM1253039 Dengue Hemorrhagic Fever Patient 38 purple
13 GSM1253040 Dengue Hemorrhagic Fever Patient 39 purple
14 GSM1253041 Dengue Hemorrhagic Fever Patient 40 purple
15 GSM1253042             Dengue Fever Patient 41   blue
16 GSM1253043             Dengue Fever Patient 42   blue
17 GSM1253044             Dengue Fever Patient 43   blue
18 GSM1253045             Dengue Fever Patient 44   blue
19 GSM1253046 Dengue Hemorrhagic Fever Patient 45 purple
20 GSM1253047             Dengue Fever Patient 47   blue
21 GSM1253048 Dengue Hemorrhagic Fever Patient 48 purple
22 GSM1253049 Dengue Hemorrhagic Fever Patient 49 purple
23 GSM1253050             Dengue Fever Patient 54   blue
24 GSM1253051             Dengue Fever Patient 55   blue
25 GSM1253052 Dengue Hemorrhagic Fever Patient 60 purple
26 GSM1253053             Dengue Fever Patient 66   blue
27 GSM1253054             Dengue Fever Patient 68   blue
28 GSM1253055             Dengue Fever Patient 80   blue
29 GSM1253056              Convalescent Patient 3  green
30 GSM1253057              Convalescent Patient 4  green
31 GSM1253058              Convalescent Patient 6  green
32 GSM1253059             Convalescent Patient 33  green
33 GSM1253060             Convalescent Patient 34  green
34 GSM1253061             Convalescent Patient 35  green
35 GSM1253062             Convalescent Patient 36  green
36 GSM1253063             Convalescent Patient 37  green
37 GSM1253064             Convalescent Patient 38  green
38 GSM1253065             Convalescent Patient 39  green
39 GSM1253066             Convalescent Patient 41  green
40 GSM1253067             Convalescent Patient 44  green
41 GSM1253068             Convalescent Patient 45  green
42 GSM1253069             Convalescent Patient 47  green
43 GSM1253070             Convalescent Patient 48  green
44 GSM1253071             Convalescent Patient 49  green
45 GSM1253072             Convalescent Patient 54  green
46 GSM1253073             Convalescent Patient 55  green
47 GSM1253074             Convalescent Patient 80  green
48 GSM1253075                  Healthy control c3 yellow
49 GSM1253076                  Healthy control c5 yellow
50 GSM1253077                  Healthy control c4 yellow
51 GSM1253078                  Healthy control c6 yellow
52 GSM1253079                  Healthy control c1 yellow
53 GSM1253080                  Healthy control c8 yellow
54 GSM1253081                  Healthy control c7 yellow
55 GSM1253082                  Healthy control c9 yellow
56 GSM1253083                  Healthy control c2 yellow



pca <- prcomp(as.matrix(t(dados$GSE51808)), cor=T, scale=F)
pairs(pca$x[,1:3], col=dfMeta$col, pch=19)
plot(
    pca$x,
    col=dfMeta$col,
    pch=19,
    main = "PCA hipotetico2",
    xlab=paste0("PC1: ", summary(pca)$importance[2,1]*100, "%"),
    ylab=paste0("PC2: ", summary(pca)$importance[2,2]*100, "%")
)
legend(
    "bottomleft", pch=rep(19,length(coloring)),
    col=coloring,
    legend=categoria
)


```
Por quest√µes que vamos explicar mais tarde, vamos separar uma amostra de cada
tipo e "tirar" elas da nossa matriz principal. Num estudo real voc√™ n√£o vai
precisar rodar as linhas a seguir.
```{r}

```

